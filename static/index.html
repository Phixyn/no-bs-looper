<!DOCTYPE html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="No BS here only loops" />
    <meta name="keywords" content="adware,must,die" />
    <title>No Bullshit YouTube Looper</title>

    <link rel="stylesheet" href="css/foundation.min.css" />
    <link rel="stylesheet" href="css/app.css" />
  </head>

  <body>
    <!-- TOP NAV BAR -->
    <div class="title-bar" data-responsive-toggle="top-navbar" data-hide-for="medium">
      <button class="menu-icon" type="button" data-toggle="top-navbar"></button>
      <div class="title-bar-title">Menu</div>
    </div> <!-- .title-bar -->

    <div class="top-bar" id="top-navbar">
      <div class="top-bar-left">
        <ul class="menu">
          <!-- SITE TITLE -->
          <li class="menu-text">No Bullshit YouTube Looper</li>
        </ul>
      </div> <!-- .top-bar-left -->

      <!-- TODO fix by probably giving menu-text padding -->
      <div class="top-bar-right">
        <ul class="menu">
          <li><a href="#">&nbsp;</a></li>
        </ul> <!-- .dropdown .menu -->
      </div> <!-- .top-bar-right -->
    </div> <!-- .top-bar #top-navbar -->

    <!-- MAIN CONTENT -->
    <div class="grid-container">
      <div class="grid-x grid-padding-x grid-padding-y">
        <div class="cell">
          <hr />
          <h1 class="h5 subheader" id="main-content-banner">&bull; Put Video Title Here &bull;</h1>
          <hr />
        </div> <!-- .cell -->

        <div class="cell medium-8 large-8 medium-offset-2 large-offset-2">
          <div class="responsive-embed widescreen">
            <!-- The <iframe> (and video player) will replace this <div> tag -->
            <div id="player"></div>
          </div> <!-- .responsive-embed .widescreen -->
        </div> <!-- .cell -->

        <div class="cell medium-6 large-6 medium-offset-3 large-offset-3">
          <form>
            <div class="input-group">
              <span class="input-group-label" style="min-width: 11.2rem;">Video ID</span>
              <input type="text" id="video-id" class="input-group-field" name="video-id" value="orxvTsPW10k">
            </div> <!-- .input-group -->

            <div class="input-group">
              <span class="input-group-label" style="min-width: 11.2rem;">Start time (seconds)</span>
              <input type="number" id="start-time" class="input-group-field" name="start-time" value="420">
            </div> <!-- .input-group -->

            <div class="input-group">
              <span class="input-group-label" style="min-width: 11.2rem;">End time (seconds)</span>
              <input type="number" id="end-time" class="input-group-field" name="end-time" value="727">
            </div> <!-- .input-group -->

            <input type="button" id="update-btn" class="button" name="update-btn" value="Update" onclick="updatePlayer()">
            <input type="reset" id="reset-btn" class="button" name="reset-btn" value="Reset"><br>
            <input type="button" id="toggle-vid-btn" class="button" name="toggle-vid-btn" value="Show/hide video" onclick="togglePlayer()">
          </form>
        </div> <!-- .cell -->

        <div class="cell">
          <hr>
          <h3>Check these out</h3>
          <ul>
            <li>id: TtsQl_X3cbw</li>
            <li>start: 828</li>
            <li>end: 1155</li>
          </ul>

          <ul>
            <li>id: Uq-TffHkCcc</li>
            <li>start: 185 / 234</li>
            <li>end: 280 / 284</li>
          </ul>
        </div> <!-- .cell -->
      </div> <!-- .grid-x -->
    </div> <!-- .grid-container -->

    <!-- FOOTER -->
    <div class="grid-container full" id="footer">
      <div class="grid-x">
        <div class="cell">
          <p class="copyright-msg">No Bullshit Software by Phixyn. No bullshit, no rights reserved. Also, no warranty.<br />
          v1.0.0</p>
        </div> <!-- .cell -->
      </div> <!-- .grid-x -->
    </div> <!-- .grid-container -->

    <script src="lib/jquery.js"></script>
    <script src="lib/what-input.js"></script>
    <script src="lib/foundation.min.js"></script>
    <script src="js/app.js"></script>

    <script>
      // TODO: move to app.js
      var videoId = document.getElementById("video-id").value;
      var startTime = parseInt(document.getElementById("start-time").value);
      var endTime = parseInt(document.getElementById("end-time").value);

      // Load the IFrame Player API code asynchronously
      var tag = document.createElement('script');

      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      var player;
      /**
       * Creates an <iframe> element (and YouTube player) after the API code
       * is downloaded.
       */
      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          height: '390',
          width: '640',
          videoId: videoId,
          playerVars: {
            rel: 0,
            start: startTime,
            modestBranding: 1
          },
          events: {
            // 'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
      }

      /**
       * Called by the API when the video player is ready.
       *
       * Reference: https://developers.google.com/youtube/iframe_api_reference#Events
       */
      // function onPlayerReady(event) {
        // event.target.playVideo();
        // Could use this, but if user seeks, endSeconds becomes invalidated
        // This is the same reason we don't have loop: 1 in our playerVars. Because
        // we have our own loop through the setInterval callback.
        // player.loadVideoById(
        //   {
        //     videoId: videoId,
        //     startSeconds: startTime,
        //     endSeconds: endTime
        //   }
        // );
      // }

      /**
       * Called by the API when the video player's state changes.
       *
       * Reference: https://developers.google.com/youtube/iframe_api_reference#Events
       */
      var timer = null;
      function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING) {
          console.debug("Interval started.");
          timer = setInterval(eventCallback, 1000);
        }
        // TODO Check if this also affects things like player state == buffering,
        // and if so, maybe improve it.
        // Update: It does. Maybe do if (event.data == YT.PlayerState.PAUSED) ?
        else {
          if (timer != null) {
            console.debug("Interval cleared from onPlayerStateChange.");
            clearInterval(timer);
          }
        }
      }

      function eventCallback() {
        if (player.getCurrentTime() >= endTime) {
          player.seekTo(startTime, true);
        }
      }

      function updatePlayer() {
        console.debug("Updating player.");
        videoId = document.getElementById("video-id").value;
        startTime = parseInt(document.getElementById("start-time").value);
        endTime = parseInt(document.getElementById("end-time").value);

        // player.loadVideoById({videoId:String,
        //               startSeconds:Number,
        //               endSeconds:Number}):Void
        // endSeconds becomes invalid if user seeks, so it's pointless
        player.loadVideoById(
          {
            videoId: videoId,
            startSeconds: startTime
          }
        );
      }

      function togglePlayer() {
        console.debug("Toggling player visibility.");
        var playerDiv = document.getElementById("player");
        // TODO Get rid of first condition by assigning display: block to #player in CSS
        if (playerDiv.style.display === "" || playerDiv.style.display !== "none") {
          playerDiv.style.display = "none";
        } else {
          playerDiv.style.display = "block";
        }
      }
    </script>
  </body>
</html>